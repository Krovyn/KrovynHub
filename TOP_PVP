local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = game:GetService("Players").LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local camera = workspace.CurrentCamera

local PREDICTION_STRENGTH = 0.016

local isEnabled = false
local selectedTarget = nil
local lastTargetPos = nil
local lastUpdateTime = tick()
local connection = nil

player:WaitForChild("DataLoaded", 60)

if not player.Character then
	game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer("SetTeam", "Pirates")
end

local function detectDevice()
	local isMobile = UserInputService.TouchEnabled and not UserInputService.MouseEnabled and not UserInputService.KeyboardEnabled
	return isMobile 
end

local isMobile = detectDevice()

task.wait(1)

local gui = Instance.new("ScreenGui")
gui.Name = "LockOnGUI"
gui.ResetOnSpawn = false
gui.Parent = playerGui

local lockButton = Instance.new("TextButton")
lockButton.Size = UDim2.new(0, 200, 0, 70)
lockButton.AnchorPoint = Vector2.new(0.5,0.5)
lockButton.Position = UDim2.new(0.5, 0, 0, 20)
lockButton.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
lockButton.Text = ""
lockButton.AutoButtonColor = false
lockButton.Active = true
lockButton.Draggable = true

local lockCorner = Instance.new("UICorner")
lockCorner.CornerRadius = UDim.new(0, 14)
lockCorner.Parent = lockButton
lockButton.Parent = gui

local settingsButton = Instance.new("TextButton")
settingsButton.Size = UDim2.new(0, 55, 0, 55)
settingsButton.Position = UDim2.new(1, -60, 0.5, -27.5)
settingsButton.BackgroundTransparency = 1
settingsButton.Text = "⚙️"
settingsButton.TextColor3 = Color3.fromRGB(255, 255, 255)
settingsButton.Font = Enum.Font.SourceSansBold
settingsButton.TextSize = 30
settingsButton.AutoButtonColor = false

local gearCorner = Instance.new("UICorner")
gearCorner.CornerRadius = UDim.new(0, 12)
gearCorner.Parent = settingsButton
settingsButton.Parent = lockButton

local lockText = Instance.new("TextLabel")
lockText.Size = UDim2.new(1, -80, 1, 0)
lockText.Position = UDim2.new(0, 35, 0, 0)
lockText.BackgroundTransparency = 1
lockText.Text = "Run OFF"
lockText.TextColor3 = Color3.fromRGB(255, 255, 255)
lockText.Font = Enum.Font.SourceSansBold
lockText.TextSize = 28
lockText.TextXAlignment = Enum.TextXAlignment.Left
lockText.Parent = lockButton

local targetLabel = Instance.new("TextLabel")
targetLabel.Size = UDim2.new(0.9,0,0.2,0)
targetLabel.Position = UDim2.new(0.05,0,0.75,0)
targetLabel.BackgroundTransparency = 1
targetLabel.TextColor3 = Color3.fromRGB(255, 0, 0)
targetLabel.TextTransparency = 0.3
targetLabel.Font = Enum.Font.SourceSansBold
targetLabel.TextSize = 16
targetLabel.Text = ""
targetLabel.Visible = false
targetLabel.Parent = lockButton

local targetCorner = Instance.new("UICorner")
targetCorner.CornerRadius = UDim.new(0, 12)
targetCorner.Parent = targetLabel

local settingsGui = Instance.new("Frame")
settingsGui.Size = UDim2.new(0, 260, 0, 340)
settingsGui.Position = UDim2.new(0.5, -180, 0.5, -100)
settingsGui.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
settingsGui.Visible = false
settingsGui.Active = true
settingsGui.Draggable = true

local sCorner = Instance.new("UICorner")
sCorner.CornerRadius = UDim.new(0, 16)
sCorner.Parent = settingsGui
settingsGui.Parent = gui

local buttonScroll = Instance.new("ScrollingFrame")
buttonScroll.Size = UDim2.new(0.9, 0, 0.75, 0)
buttonScroll.Position = UDim2.new(0.05, 0, 0.15, 0)
buttonScroll.BackgroundTransparency = 1
buttonScroll.ScrollingDirection = Enum.ScrollingDirection.Y
buttonScroll.AutomaticCanvasSize = Enum.AutomaticSize.Y 
buttonScroll.ScrollBarThickness = 6
buttonScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
buttonScroll.Parent = settingsGui

local buttonLayout = Instance.new("UIListLayout")
buttonLayout.SortOrder = Enum.SortOrder.LayoutOrder
buttonLayout.Padding = UDim.new(0, 10)
buttonLayout.Parent = buttonScroll

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 45)
title.BackgroundTransparency = 1
title.Text = "Krovyn Hub"
title.TextColor3 = Color3.fromRGB(255, 0, 0)
title.TextTransparency = 0
title.TextStrokeColor3 = Color3.fromRGB(255, 255, 255)
title.TextStrokeTransparency = 0
title.Font = Enum.Font.SourceSansBold
title.TextSize = 32
title.Parent = settingsGui

local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0, 38, 0, 38)
closeBtn.Position = UDim2.new(1, -45, 0, 4)
closeBtn.BackgroundTransparency = 1
closeBtn.Text = "X"
closeBtn.TextColor3 = Color3.fromRGB(255, 100, 100)
closeBtn.Font = Enum.Font.SourceSansBold
closeBtn.TextSize = 24
closeBtn.Parent = settingsGui

local function createSwitch(parent, text, default, callback)
	local frame = Instance.new("Frame", parent)
	frame.Size = UDim2.new(1, -10, 0, 30)
	frame.BackgroundTransparency = 0.5
	frame.BackgroundColor3 =Color3.new(0, 0, 0)
	local frameCorner = Instance.new("UICorner", frame)
	frameCorner.CornerRadius = UDim.new(0, 13)
	local label = Instance.new("TextLabel", frame)
	label.Size = UDim2.new(0.6, 0, 1, 0)
	label.Position = UDim2.new(0, 0, 0, 0)
	label.BackgroundTransparency = 1
	label.Text = text
	label.TextXAlignment = Enum.TextXAlignment.Left
	label.Font = Enum.Font.GothamBold
	label.TextSize = 14
	label.TextColor3 = Color3.new(1, 1, 1)
	local switchBase = Instance.new("Frame", frame)
	switchBase.Size = UDim2.new(0, 50, 0, 24)
	switchBase.Position = UDim2.new(1, -60, 0.5, -12)
	switchBase.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
	switchBase.BackgroundTransparency = 0.3
	switchBase.Name ="SwitchBase"
	local baseCorner = Instance.new("UICorner", switchBase)
	baseCorner.CornerRadius = UDim.new(1, 0)
	local handle = Instance.new("Frame", switchBase)
	handle.Size = UDim2.new(0, 20, 0, 20)
	handle.Position = UDim2.new(0, 2, 0.5, -10)
	handle.BackgroundColor3 = Color3.new(1, 1, 1)
	local handleCorner = Instance.new("UICorner", handle)
	handleCorner.CornerRadius = UDim.new(1, 0)
	local state = default or false
	local function updateUI()
		if state then
			switchBase.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
			handle:TweenPosition(UDim2.new(1, -22, 0.5, -10), "Out", "Quad", 0.2, true)
		else
			switchBase.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
			handle:TweenPosition(UDim2.new(0, 2, 0.5, -10), "Out", "Quad", 0.2, true)
		end
	end
	switchBase.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 
			or input.UserInputType == Enum.UserInputType.Touch then
			state = not state
			updateUI()
			if callback then callback(state) end
		end
	end)
	updateUI()
	return frame
end

local function createInputBox(parent, text, defaultText, callback)
	local frame = Instance.new("Frame", parent)
	frame.Size = UDim2.new(1, -10, 0, 30)
	frame.BackgroundTransparency = 0.5
	frame.BackgroundColor3 = Color3.new(0, 0, 0)
	local frameCorner = Instance.new("UICorner", frame)
	frameCorner.CornerRadius = UDim.new(0, 13)
	local label = Instance.new("TextLabel", frame)
	label.Size = UDim2.new(0.6, 0, 1, 0)
	label.Position = UDim2.new(0, 0, 0, 0)
	label.BackgroundTransparency = 1
	label.Text = text
	label.TextXAlignment = Enum.TextXAlignment.Left
	label.Font = Enum.Font.GothamBold
	label.TextSize = 14
	label.TextColor3 = Color3.new(1, 1, 1)
	local inputBox = Instance.new("TextBox", frame)
	inputBox.Size = UDim2.new(0, 50, 0, 24)
	inputBox.Position = UDim2.new(1, -60, 0.5, -12)
	inputBox.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
	inputBox.BackgroundTransparency = 0.3
	inputBox.Text = defaultText or ""
	inputBox.Font = Enum.Font.GothamBold
	inputBox.TextSize = 14
	inputBox.TextColor3 = Color3.new(1, 1, 1)
	inputBox.PlaceholderText = "enter..."
	inputBox.ClearTextOnFocus = false
	local corner = Instance.new("UICorner", inputBox)
	corner.CornerRadius = UDim.new(1, 0)
	inputBox.FocusLost:Connect(function()
		if callback then
			callback(inputBox.Text)
		end
	end)
	return frame
end

local function createButton(parent, text)
	local button = Instance.new("TextButton")
	button.Size = UDim2.new(1, -10, 0, 30)
	button.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
	button.BackgroundTransparency =  0.3
	button.TextColor3 = Color3.new(1, 1, 1)
	button.Text = text
	button.Font = Enum.Font.GothamBold
	button.TextSize = 14
	button.Parent = parent
	local corner = Instance.new("UICorner", button)
	corner.CornerRadius = UDim.new(0, 13)
	return button
end

local camLock = true
local camLockSwitch =createSwitch(buttonScroll, "Cam Lock", true, function(state)
	camLock = state
end)

local predictionInput = createInputBox(buttonScroll, "Prediction Strength", "0.016", function(value)
	PREDICTION_STRENGTH = value
end)

local fastAttack = false
local fastAttackSwitch =createSwitch(buttonScroll, "Fast Attack", false, function(state)
	fastAttack = state
end)

local function IsEntityAlive(entity)
	if not entity then return false end
	local humanoid = entity:FindFirstChild("Humanoid")
	return humanoid and humanoid.Health > 0
end

local function GetEnemiesInRange(character, range)
	local enemies = game:GetService("Workspace").Enemies:GetChildren()
	local players = game:GetService("Players"):GetPlayers()
	local targets = {}
	local playerPos = character:GetPivot().Position
	for _, enemy in ipairs(enemies) do
		local rootPart = enemy:FindFirstChild("HumanoidRootPart")
		if rootPart and IsEntityAlive(enemy) then
			local distance = (rootPart.Position - playerPos).Magnitude
			if distance <= range then
				table.insert(targets, enemy)
			end
		end
	end
	for _, otherPlayer in ipairs(players) do
		if otherPlayer ~= player and otherPlayer.Character then
			local rootPart = otherPlayer.Character:FindFirstChild("HumanoidRootPart")
			if rootPart and IsEntityAlive(otherPlayer.Character) then
				local distance = (rootPart.Position - playerPos).Magnitude
				if distance <= range then
					table.insert(targets, otherPlayer.Character)
				end
			end
		end
	end
	return targets
end

local attackRange = 60
local function attackNoCoolDown()
	local character = player.Character
	local hrp = character:FindFirstChild("HumanoidRootPart")
	if not hrp then return end
	local equippedWeapon
	for _, item in ipairs(character:GetChildren()) do
		if item:IsA("Tool") then
			equippedWeapon = item
			break
		end
	end
	if not equippedWeapon then return end

	local enemiesInRange = GetEnemiesInRange(character, attackRange)
	if equippedWeapon:FindFirstChild("LeftClickRemote") then
		local attackCount = 1  
		for _, enemy in ipairs(enemiesInRange) do
			local rootPart = enemy:FindFirstChild("HumanoidRootPart")
			if rootPart then
				local direction = (rootPart.Position - character:GetPivot().Position).Unit
				equippedWeapon.LeftClickRemote:FireServer(direction, attackCount)
				attackCount = attackCount + 1
			end
		end
	else
		local targets, mainTarget = {}, nil
		for _, enemy in ipairs(enemiesInRange) do
			if not enemy:GetAttribute("IsBoat") then
				local head = enemy:FindFirstChild("Head")
				if head then
					table.insert(targets, { enemy, head })
					mainTarget = head
				end
			end
		end
		if mainTarget then
			local attackEvent = game:GetService("ReplicatedStorage"):WaitForChild("Modules"):WaitForChild("Net"):WaitForChild("RE/RegisterAttack")
			local hitEvent = game:GetService("ReplicatedStorage"):WaitForChild("Modules"):WaitForChild("Net"):WaitForChild("RE/RegisterHit")
			pcall(function()
				attackEvent:FireServer(0.1)
				hitEvent:FireServer(mainTarget, targets)
			end)
		end
	end
end

task.spawn(function()
	while task.wait(0.1) do
		if fastAttack and isEnabled then
			attackNoCoolDown()
		end
	end
end)

local v3Mode = true
local v3ModeSwitch =createSwitch(buttonScroll, "Auto v3", true, function(state)
	v3Mode = state
end)

task.spawn(function()
	while task.wait(0.5) do       
		pcall(function()
			if v3Mode and isEnabled then
				game:GetService("ReplicatedStorage").Remotes.CommE:FireServer("ActivateAbility")
			end
		end)
	end
end)

local v4Mode = true
local v4ModeSwitch =createSwitch(buttonScroll, "Auto v4", true, function(state)
    v4Mode = state
end)

task.spawn(function()
	while true do
		task.wait(0.5)
		if v4Mode and isEnabled then
			local character = game.Players.LocalPlayer.Character
			if character and character:FindFirstChild("RaceEnergy") and
				character.RaceEnergy.Value >= 1 and
				not character.RaceTransformed.Value then
				local be = game:GetService("VirtualInputManager")
				be:SendKeyEvent(true, "Y", false, game)
				task.wait(0.1)
				be:SendKeyEvent(false, "Y", false, game)
			end
		end
	end
end)

local SpeedConnection
local function ApplySpeed()
	local Character = player.Character
	if Character then
		local Humanoid = Character:FindFirstChildOfClass("Humanoid")
		if Humanoid then
			if speedHack and walkSpeed then
				if SpeedConnection then
					SpeedConnection:Disconnect()
				end
				Humanoid.WalkSpeed = walkSpeed
				SpeedConnection = Humanoid:GetPropertyChangedSignal("WalkSpeed"):Connect(function()
					if speedHack then
						Humanoid.WalkSpeed = walkSpeed
					end
				end)
			else
				Humanoid.WalkSpeed = 16
				if SpeedConnection then
					SpeedConnection:Disconnect()
				end
			end
		end
	end
end
local speedHackSwitch = createSwitch(buttonScroll,"Speed Hack",false,function(state)
	speedHack = state
	ApplySpeed()
end)
local speedHackInput =createInputBox(buttonScroll,"Speed Value","16",function(value)
	local num =tonumber(value)
	if num and num >= 0 then
		walkSpeed =num
		ApplySpeed()
	end
end)
local JumpConnection
local function ApplyJumpPower()
	local Character = player.Character
	if Character then
		local Humanoid = Character:FindFirstChildOfClass("Humanoid")
		if Humanoid then
			if jumpHack and jumpPower then
				if JumpConnection then
					JumpConnection:Disconnect()
				end
				Humanoid.UseJumpPower = true
				Humanoid.JumpPower = jumpPower
				print(jumpPower)
				JumpConnection = Humanoid:GetPropertyChangedSignal("JumpPower"):Connect(function()
					if jumpHack then
						Humanoid.JumpPower = jumpPower
					end
				end)
			else
				Humanoid.JumpPower = 50
				if JumpConnection then
					JumpConnection:Disconnect()
				end
			end
		end
	end
end
local jumpHackSwitch = createSwitch(buttonScroll,"Jump Hack",false,function(state)
	jumpHack = state
	ApplyJumpPower()
end)
local jumpHackInput = createInputBox(buttonScroll,"Jump Value","50",function(value)
	local num =tonumber(value)
	if num and num >= 0 then
		jumpPower =num
		ApplyJumpPower()
	end
end)

local fixCameraShakeButton =createButton(buttonScroll,"Fix CameraShake")
fixCameraShakeButton.MouseButton1Click:Connect(function()
	local Util = game:GetService("ReplicatedStorage"):WaitForChild("Util", 5)
	if Util then
		local CameraShaker = Util:FindFirstChild("CameraShaker")
		if CameraShaker then
			require(CameraShaker):Stop()
		end
	end
end)

local function updateTargetName()
	if selectedTarget and isEnabled then
		targetLabel.Text = "target:  " .. selectedTarget.Name
		targetLabel.Visible = true
	else
		targetLabel.Text = ""
		targetLabel.Visible = false
	end
end

local function findClosestAlivePlayer()
	local closest = nil
	local minDist = math.huge
	local camPos = camera.CFrame.Position
	local lookDir = camera.CFrame.LookVector

	for _, p in game:GetService("Players"):GetPlayers() do
		if p ~= player and p.Character then
			local root = p.Character:FindFirstChild("HumanoidRootPart")
			local hum = p.Character:FindFirstChild("Humanoid")
			if root and hum and hum.Health > 0 then
				local toTarget = root.Position - camPos
				local dist = toTarget.Magnitude
				local dot = lookDir:Dot(toTarget.Unit)
				if dot > 0.6 and dist < minDist then
					closest = p
					minDist = dist
				end
			end
		end
	end
	return closest
end

local function updateCamera()
	if not isEnabled or not selectedTarget or not selectedTarget.Character or not camLock then
		if player.Character and player.Character:FindFirstChild("Humanoid") then
			camera.CameraSubject = player.Character.Humanoid
			camera.CameraType = Enum.CameraType.Custom
		end
		return
	end

	local root = selectedTarget.Character:FindFirstChild("HumanoidRootPart")
	if not root then
		updateTargetName()
		return
	end

	local now = tick()
	local deltaTime = now - lastUpdateTime
	lastUpdateTime = now

	local currentPos = root.Position
	local velocity = lastTargetPos and ((currentPos - lastTargetPos) / deltaTime) or Vector3.new()
	lastTargetPos = currentPos

	
	local distance = (camera.CFrame.Position - root.Position).Magnitude
	local dynamicOffset = 5 * (distance / 100) 

	local predictedPos = currentPos + velocity * PREDICTION_STRENGTH
	if isMobile then
		predictedPos = predictedPos - Vector3.new(0, dynamicOffset, 0) 
	end
	local targetCFrame = CFrame.new(camera.CFrame.Position, predictedPos)
	camera.CFrame = camera.CFrame:Lerp(targetCFrame, 1)
end

local function toggleLockOn()
	isEnabled = not isEnabled

	if isEnabled then
		lockText.Text = "Run ON"
		selectedTarget = findClosestAlivePlayer()
		if selectedTarget then
			lastTargetPos = selectedTarget.Character.HumanoidRootPart.Position
			lastUpdateTime = tick()
			updateTargetName()
		else
			isEnabled = false
			lockText.Text = "Run OFF"
			updateTargetName()
			return
		end
		connection = RunService.RenderStepped:Connect(updateCamera)
	else
		lockText.Text = "Run OFF"
		if connection then connection:Disconnect() end
		selectedTarget = nil
		lastTargetPos = nil
		updateTargetName()
		camera.CameraType = Enum.CameraType.Custom
	end
end

lockButton.MouseButton1Click:Connect(toggleLockOn)

settingsButton.MouseButton1Click:Connect(function()
	settingsGui.Visible = not settingsGui.Visible
end)

closeBtn.MouseButton1Click:Connect(function()
	settingsGui.Visible = false
end)

camera.CameraType = Enum.CameraType.Custom
